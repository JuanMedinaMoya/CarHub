{% extends 'navbar.html' %}

{% block head %}
{{ super() }}
<title>Viaje</title>
<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
<script
   src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDznNAUPqKZhq9Czvpzq3Nl8ppJOd0L_XI&callback=initMap&v=weekly"
   defer></script>
<style type="text/css">
   #map {
      height: 50%;
      width: 50%;
      margin: 0 auto;
   }

   html,
   body {
      height: 100%;
      margin: 0;
      padding: 0;
   }
</style>
<script>
   function initMap() {
      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer();
      const map = new google.maps.Map(document.getElementById("map"), {
         zoom: 7,
         center: { lat: 41.85, lng: -87.65 },
      });

      directionsRenderer.setMap(map);

      directionsService
         .route({
            origin: "{{ trayecto['origenstr'] }}",
            destination: "{{ trayecto['destinostr'] }}",
            travelMode: google.maps.TravelMode.DRIVING,
         })
         .then((response) => {
            directionsRenderer.setDirections(response);
         })
         .catch((e) => window.alert("Directions request failed due to " + status));
   }

</script>
{% endblock %}
<!-- INTRO
         ================================================== -->
{% block body %}
<section id="viaje"
   style="padding:160px 0;background-image: url(../static/images/fondo.jpg); background-position: center; background-repeat: no-repeat;background-size: cover;background-attachment:fixed;"
   class="min-vh-100">
   <div class="container">
      <div class="textwidget">
         <h1 class="toptitle" style="color:#20b2aa; -webkit-text-stroke: 1px black;">
            {{trayecto['horasalida'].strftime('El %d/%m/%Y a las %H:%M') }}<br />
            {{ trayecto['origenstr'] }} ➜ {{ trayecto['destinostr'] }}<br /><br />
            <i class="fa fa-car roundicon"></i>
         </h1>

         <div class="contactstyle topform">
            <style>
               #activo {
                  background-color: rgb(10, 124, 0);
                  border-color: rgb(10, 80, 3);
                  text-align: center;
               }
            </style>


            {% if trayecto['finalizado'] == 0 %}
            {% if session['username'] == conductor['username'] %}
            <p>
               {% if trayecto['pasajeros']|length == 0 %}

               <a href="/mostrar_editar_trayecto/{{ trayecto['_id'] }}">
                  <button type="button" class="btn btn-primary btn-lg">Editar</button>
               </a>

               {% endif %}

               {% if fechahoy < trayecto['horasalida'] %} <a href="/#">
                  <button type="button" class="btn btn-danger">Borrar</button>
                  </a>
                  {% else %}
                  <a href="/#">
                     <button type="button" class="btn btn-dark">Finalizar</button>
                  </a>
                  {% endif %}
            </p>
            {% else %}
            {% if usuario is not none %}

            {% endif %}

            {% if fechahoy < trayecto['horasalida'] %} <p>
               <a href="/#">
                  <button type="button" class="btn btn-danger">Salirse</button>
               </a>
               </p>
               {% endif %}
               {% endif %}
               {% else %}
               {% if session['username'] == conductor['username'] %}
               <p>
                  {% for pasajero in pasajeros %}
                  <a href="/#">
                     <button type="button" class="btn btn-primary btn-lg">Valorar a {{ pasajero['username'] }}</button>
                  </a>
                  {% endfor %}
               </p>
               {% else %}
               <p>
                  <a href="/#">
                     <button type="button" class="btn btn-primary btn-lg">Valorar a {{conductor['username']}}</button>
                  </a>
               </p>
               {% endif %}
               <!-- Si no ha finalizado  -->
               {% endif %}

               <ul class="list-group">
                  <li class="list-group-item">
                     <h3 style="color:rgb(10, 124, 0);">SALIDA: </h3>
                     {{ trayecto['origenstr'] }}
                  </li>
                  <li class="list-group-item">
                     <h3 style="color:rgb(10, 124, 0);">LLEGADA: </h3>
                     {{ trayecto['destinostr'] }}
                  </li>
                  <li class="list-group-item">
                     <h3 style="color:rgb(10, 124, 0);">Duracion estimada: </h3>
                     {{ duracion }}
                  </li>
                  <li class="list-group-item">
                     <h3 style="color:rgb(10, 124, 0);">Asientos disponibles: </h3>
                     {{ trayecto['numeropasajeros'] }}
                  </li>
                  <br>
                  <div id="map" style="width: 400px; height: 400px;"></div>

                  <!-- Solo para los que compran el viaje  -->
                  {% if session['username'] != conductor['username'] %}
                  <span class="d-inline-block" data-bs-toggle="tooltip" data-bs-placement="bottom"
                     title="pagar trayecto">
                     <!-- Button trigger modal -->
                     <button type="button" class="list-group-item list-group-item-action active btn " id="activo"
                        data-bs-toggle="modal" data-bs-target="#exampleModal">
                        <h3 style="color:rgb(255, 255, 255);">Precio: {{ trayecto['precio'] }} €</h3>
                     </button>
                     <!-------------------------->
                  </span>
                  {% endif %}

                  <!-- Modal -->
                  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                     aria-hidden="true">
                     <div class="modal-dialog">
                        <div class="modal-content">
                           <div class="modal-header">
                              <h5 class="modal-title" id="exampleModalLabel">Pagar trayecto</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"
                                 aria-label="Close"></button>
                           </div>
                           <div class="modal-body">
                              <p>Seleccione el numero de asientos:</p>
                           </div>
                           <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              <button type="button" class="btn btn-primary">Save changes</button>
                           </div>
                        </div>
                     </div>
                  </div>



               </ul>

               <div class="col">
                  <div class="row">
                     <h3 style="color:rgb(10, 124, 0);">Conductor: </h3>
                  </div>
                  <a href="/perfilId/{{ conductor['_id'] }}"
                     class="list-group-item list-group-item-action flex-column align-items-start">
                     <div class="card card-body">
                        <p>{{ conductor['nombre'] }} {{ conductor['apellidos'] }}</p>
                        <small>Coche: {{ conductor['coche'] }} </small>
                        {%if estavalorado == false%}
                        <a href="/valorar/{{trayecto['_id']}}/{{ conductor['_id'] }}">
                           <button type="button" class="btn btn-warning">Valorar</button>
                        </a>
                        {%endif%}
                     </div>
                  </a>
                  </br>

                  {% if pasajeros %}
                  <div class="row">
                     <h3 style="color:rgb(10, 124, 0);">Pasajeros </h3>
                  </div>
                  {% for pasajero in pasajeros %}
                  <a href="/perfilId/{{ pasajero['_id'] }}"
                     class="list-group-item list-group-item-action flex-column align-items-start">
                     <div class="card card-body">
                        <p>{{ pasajero['nombre'] }} {{ pasajero['apellidos'] }}</p>
                     </div>
                  </a>
                  {% endfor %}
                  {% endif %}

               </div>
         </div>
      </div>
</section>

{% endblock %}
{% block footer %}
{{ super() }}
{% endblock %}